<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>GDP Cities 2015-2016</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.46.0/mapbox-gl.js'></script>
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.2.0/mapbox-gl-geocoder.min.js'></script>
    <script src='js/dom.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.46.0/mapbox-gl.css' rel='stylesheet'/>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.2.0/mapbox-gl-geocoder.css' type='text/css' />
    <link href='css/styles.css' rel='stylesheet', type='text/css'/>
    <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
</head>

<body>
<div id='container'>
<div id="links">
    <ul class='docs'>
      <li><a href="https://github.com/wireman27/india_gdp_new" target="_blank">Github</a></li>
      <li><a href="https://wireman27.github.io/india_gdp_new/qgis_docs" target="_blank">QGIS Walkthrough</a></li>
      <li><a href="http://www.ngdc.noaa.gov/eog/pubs/Ghosh_TOGEOGJ.pdf" target="_blank">Original Paper</a></li>
      <li><a href=javascript:compareTool() style='color:orange'>Compare States</a></li>
    </ul>
</div>

<div id='control-toggle' onclick='toggleControls()'></div>

<div id='controls'>
    <h3>Toggle Layers</h3>
    <ul class='toggle'>
        <li id='gdp-data-toggle'>
            <input type="checkbox" id="gdp-data"  onclick="toggleLayer(this.id)">
            GDP
        </li>
        <li id='airlinks-toggle'>
            <input type="checkbox" id="airlinks"  onclick="toggleLayer(this.id)">
            <p class='tooltip'>Air Links
            <span class='tooltiptext'>Air links weighted by total weekly passenger capacity based on summer schedule data from DGCA. More info <a href='http://dgca.nic.in/dom_flt_schedule/flt_index.htm' target='_blank'>here</a> </span>
            </p>
        </li>
        <li id='states-boundary-toggle'>
            <input type="checkbox" id="states-boundary"  onclick="toggleLayer(this.id)">
            State Boundaries
        </li>
    </ul>
</div>


<div id='allmaps'>
<div id='map'></div>
<div class = 'comparemaps' id='cmap1'></div>
<div class = 'comparemaps' id='cmap2'></div>
</div>
</div>
<script>

mapboxgl.accessToken = 'pk.eyJ1IjoiY2l0eS13YWxrYWJpbGl0eSIsImEiOiJjamFncnNkODUycHRnMzNuaW14eHE5d24yIn0.0ty0jyl5uuIF4fulta_vjg';

// declaring some variables

var states_tiles = 'wireman27.dzygdngz';
var states_layer = 'State_wi2';
var states_url = 'https://a.tiles.mapbox.com/v4/'+states_tiles+'/{z}/{x}/{y}.mvt?access_token='+mapboxgl.accessToken;

var gdp_tiles = 'wireman27.33q9yb3c';
var gdp_layer = 'gdpp_ws';
var url = 'https://a.tiles.mapbox.com/v4/'+gdp_tiles+'/{z}/{x}/{y}.mvt?access_token='+mapboxgl.accessToken;

var airlinks_tiles = 'wireman27.ajp9l3mx';
var airlinks_layer = 'airlinks';
var airlinks_url = 'https://a.tiles.mapbox.com/v4/'+airlinks_tiles+'/{z}/{x}/{y}.mvt?access_token='+mapboxgl.accessToken;

var currentZoom = 5;
var hoveredStateId =  null;
var bounds = [
    [50.22214724308444,7.167155470801902],
    [104.30007044563308,39.99115993534974]
];
var is_compare_states = false;
var states_select = 0;
var selectedStates = [];
var bbox_correct = [-3,-3,3,3];

var compareAttributes = {
    "gsdp_mill":"Gross State Domestic Product (Million)",
    "gsdp_sqkm_mill": "GSDP (Million) Per Sq Km",
    "agri_ratio":"GSDP Attributable to Agriculture"
}

var table;

var statesMetadata; 
var statesMetadataUrl = 'https://raw.githubusercontent.com/wireman27/india_gdp_new/master/json/statesMetadata.json'


var links = document.getElementsByClassName("docs");

// initializing map

var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/wireman27/cjjxpgblc4lco2spl206pi2d9',
    zoom: 4,
    center: [77.645, 21.69],
    pitch: 0,
    bearing: 0.6,
    minZoom: 3,
    hash: true,
    maxBounds: bounds
});

// declaring some functions

function addGdp(themap) {
    themap.addSource("gdp",{
        "type":"vector",
        "tiles": [url],
        "cluster":true
    });
}

function addStates(themap) {
    themap.addSource("states",{
        "type":"vector",
        "tiles": [states_url]
    });
}

function addAirlinks(themap) {
    themap.addSource("airlinks",{
        "type":"vector",
        "tiles": [airlinks_url]
    });
}


function addGdpLayer(themap) {
    themap.addLayer({
        "id": "gdp-data",
        "type": "fill-extrusion",
        "source": "gdp",
        "source-layer": gdp_layer,
        'paint': {
            'fill-extrusion-color': { 
                'property': 'gdpp_mill',
                'type': 'exponential',
                'stops': [ 
                [100,'#262626'],
                [500,'#ff9933'],
                [1500,'#ff5050'],
                [4000,'#660033']
                ]
            },
            'fill-extrusion-height': ["*",["get","gdpp_mill"], 10],
            'fill-extrusion-opacity': 0.6
        }
    });
}

function addStatesLayer(themap) {
    themap.addLayer({
        "id":"states",
        "type":"fill",
        "source": "states",
        "layout": {},
        "source-layer":states_layer,
        "paint": {
            "fill-color": ["case", ["boolean",["feature-state", "click"],false], "#ffffff","#e6e600"],
            "fill-opacity": ["case",
                ["any", ["boolean", ["feature-state", "hover"], false], ["boolean", ["feature-state", "click"], false] ],
                0.1,
                0
            ]
        }
    })
}

function addAirlinksLayer(themap) {
    themap.addLayer({
        "id":"airlinks",
        "type":"line",
        "source": "airlinks",
        "layout": {
            "visibility":'none'
        },
        "source-layer":airlinks_layer,
        "paint": {
            "line-color": "black",
            "line-width":["/",["get","twc"], 20000],
            "line-opacity": 0.5
        }
    })
}

function addStatesBoundary(themap) {
    themap.addLayer({
        "id":"states-boundary",
        "type":"line",
        "source": "states",
        "layout": {},
        "source-layer":states_layer,
        "paint": {
            "line-width": 0.3,
            "line-color": "#e6e6e6",
            "line-opacity": 0.6
        }
    })
}

function addDataLayer() {
    addGdpLayer(map);
    addStatesLayer(map);
    addAirlinksLayer(map);
    addStatesBoundary(map);
}

//making the map pretty

map.on('style.load', function () {
    addGdp(map);
    addStates(map);
    addAirlinks(map);
    document.getElementById('gdp-data').checked = true;
    document.getElementById('states-boundary').checked = true;
    addDataLayer();
});

// compare tool

function backToHome() {
	backToHomeUI();
	for (var feat = 0;feat < selectedStates.length;feat++) {
		map.setFeatureState({source: 'states', sourceLayer: states_layer, id: selectedStates[feat].id},{click: false})
	}
	selectedStates = [];
	states_select = 0;
	is_compare_states = false;

}

function compareTool() {

    is_compare_states = true;
    var states_select = 0;

    if(!statesMetadata) {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
       // Typical action to be performed when the document is ready:
                statesMetadata = JSON.parse(xhttp.responseText)
            }
        };
        xhttp.open("GET",statesMetadataUrl,true);
        xhttp.send();
    }

    compareToolUI();
}

function createBounds(turf_bounds) {
    var sum = turf_bounds.map(function (num, idx) {
        return num + bbox_correct[idx];
    })
    return(sum);
}

function goBackFromCompare() {

    compareTool();

    cmap1.remove();
    cmap2.remove();

    goBackFromCompareUI();
}

function compareStates() {

    if (states_select < 2) {
        alert("Please select more states!");
        return;
    }

    state1 = selectedStates[0]; state2 = selectedStates[1];
    center1 = turf.center(state1.geometry).geometry.coordinates; center2 = turf.center(state2.geometry).geometry.coordinates;
    bounds1 = createBounds(turf.bbox(state1)); bounds2 = createBounds(turf.bbox(state2));

    compareStatesUI();

    var cmap1 = new mapboxgl.Map({
        container: 'cmap1',
        style: 'mapbox://styles/mapbox/dark-v9?optimize=true',
        zoom: 5,
        center: center1,
        minZoom: 5,
        maxBounds: bounds1
    });

    cmap1.on('load', function() {
        addGdp(cmap1);
        addGdpLayer(cmap1);
        addStates(cmap1);
        addStatesBoundary(cmap1);


        var filter1 = ["==","state_id",state1.properties.St_Csus_Cd];

        cmap1.setFilter('states-boundary',["==","St_Csus_Cd",state1.properties.St_Csus_Cd])
        cmap1.setFilter('gdp-data',filter1);
        
    });

    var cmap2 = new mapboxgl.Map({
        container: 'cmap2',
        style: 'mapbox://styles/mapbox/dark-v9?optimize=true',
        zoom: 5,
        center: center2,
        minZoom: 5,
        maxBounds: bounds2
    });

    cmap2.on('load', function() {
        addGdp(cmap2);
        addGdpLayer(cmap2);
        addStates(cmap2);
        addStatesBoundary(cmap2);

        var filter2 = ["==","state_id",state2.properties.St_Csus_Cd];

        cmap2.setFilter('states-boundary',["==","St_Csus_Cd",state2.properties.St_Csus_Cd])
        cmap2.setFilter('gdp-data',filter2);
    });

    createComparisonTable();


}

function round(value, decimals) {
  return Number(Math.round(value+'e'+decimals)+'e-'+decimals);
}

function createComparisonTable() {

    table = document.createElement('table');
    table.setAttribute('id','compareTable');

    for (var att in compareAttributes) {
        var row = document.createElement('tr');

        var td1 = document.createElement('td'); var td2 = document.createElement('td'); var td3 = document.createElement('td'); 
        td1.setAttribute('class','td1');td2.setAttribute('class','td2');td3.setAttribute('class','td3');

        td1.innerText = round(statesMetadata[selectedStates[0].id][att],2);
        td2.innerText = compareAttributes[att]
        td3.innerText = round(statesMetadata[selectedStates[1].id][att],2);

        row.appendChild(td1); row.appendChild(td2); row.appendChild(td3);

        table.appendChild(row);
    }

    document.getElementById('container').appendChild(table);

    document.getElementsByClassName("mapboxgl-ctrl-attrib")[1].style.display = 'none';
    document.getElementsByClassName("mapboxgl-ctrl-logo")[1].style.display = 'none';
    document.getElementsByClassName("mapboxgl-ctrl-attrib")[2].style.display = 'none';
    document.getElementsByClassName("mapboxgl-ctrl-logo")[2].style.display = 'none';

}

function toggleLayer(layerName) {
    if(map.getLayoutProperty(layerName, 'visibility') == 'none') {
        map.setLayoutProperty(layerName,'visibility','visible')
    } else {
        map.setLayoutProperty(layerName,'visibility','none')
    }
}

function toggleControls() {
    if (document.getElementById('controls').style.display=='none') {
        document.getElementById('controls').style.display = 'block';
    } else {
        document.getElementById('controls').style.display = 'none';
    }
}


// events



// map.on('zoomend', function(){
//     var zoomEnd = map.getZoom();
//     if(currentZoom < 9.5 && zoomEnd > 9.5) { 
//         //document.getElementById('loader').style.display = 'block';
//         map.setStyle('mapbox://styles/mapbox/satellite-v9?optimize=true')
//         currentZoom = zoomEnd;
//     }
//     if(currentZoom > 9.5 && zoomEnd < 9.5) { 
//         map.setStyle('mapbox://styles/mapbox/dark-v9?optimize=true')
//         currentZoom = zoomEnd;
//     }
// });

map.on('click','states',function(e) {
    if (hoveredStateId && !is_compare_states) {
        var bbox = turf.bbox(e.features[0]);
        map.fitBounds(bbox);
    }
    if (is_compare_states && e.features.length > 0) {
        var clickStat = map.getFeatureState({source: 'states', sourceLayer: states_layer, id: e.features[0].id}).click
        if (clickStat != true) {
            if (states_select < 2) {
                map.setFeatureState({source: 'states', sourceLayer: states_layer, id: e.features[0].id},{click: true});
                states_select++;
                selectedStates.push(e.features[0]);
            } 
        } else {
            map.setFeatureState({source: 'states', sourceLayer: states_layer, id: e.features[0].id},{click: false});
            states_select--;
            selectedStates.pop(e.features[0]);
        }
    };
})

map.on("mousemove", "states", function(e) {
    if(map.getZoom() > 7) {
        map.setFeatureState({source: 'states', sourceLayer: states_layer, id: hoveredStateId}, { hover: false});
    } else {
    if (e.features.length > 0) {
        if (hoveredStateId) {
            map.setFeatureState({source: 'states', sourceLayer: states_layer, id: hoveredStateId}, { hover: false});
        }
        hoveredStateId = e.features[0].id;
        map.setFeatureState({source: 'states', sourceLayer: states_layer, id: hoveredStateId}, { hover: true});
    }        
    }
});

map.on("mouseleave", "states", function() {   
    if(map.getZoom() > 7) {
        map.setFeatureState({source: 'states', sourceLayer: states_layer, id: hoveredStateId}, { hover: false});
    }
    if (hoveredStateId) {
        map.setFeatureState({source: 'states', sourceLayer: states_layer, id: hoveredStateId}, { hover: false});
    }
    hoveredStateId =  null;
});

map.addControl(new MapboxGeocoder({
    accessToken: mapboxgl.accessToken,
    country: 'in'
}));
// map.addControl(new mapboxgl.FullscreenControl());

</script>

</body>
</html>