<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>GDP Cities 2015-2016</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.46.0/mapbox-gl.js'></script>
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.2.0/mapbox-gl-geocoder.min.js'></script>
    <script src='js/dom.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.46.0/mapbox-gl.css' rel='stylesheet'/>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.2.0/mapbox-gl-geocoder.css' type='text/css' />
    <link href="css/nouislider.min.css" rel="stylesheet">
    <link href='css/styles.css' rel='stylesheet', type='text/css'/>
    <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
</head>


<body>
<div id='container'>
    <div id="links">
        <ul class='docs'>
          <li><a href="https://github.com/wireman27/india_gdp_new" target="_blank">Github</a></li>
          <li><a href="https://wireman27.github.io/india_gdp_new/qgis_docs" target="_blank">QGIS Walkthrough</a></li>
          <li><a href="http://www.ngdc.noaa.gov/eog/pubs/Ghosh_TOGEOGJ.pdf" target="_blank">Original Paper</a></li>
          <li><a href=javascript:compareTool() style='color:orange'>Compare States</a></li>
        </ul>
    </div>

    <div id='control-toggle' onclick='toggleControls()'></div>

    <div id='controls'>
        <h3>Toggle Layers</h3>
        <ul class='toggle'>
            <li id='gdp-data-toggle'>
                <input type="checkbox" id="gdp-data"  onclick="toggleLayer(this.id)">
                GDP
            </li>
            <li id='airlinks-toggle'>
                <input type="checkbox" id="airlinks"  onclick="toggleLayer(this.id)">
                <p class='tooltip'>Airlinks
                <span class='tooltiptext'>Air links weighted by total weekly passenger capacity on a given route based on summer schedule <a href='http://dgca.nic.in/dom_flt_schedule/flt_index.htm' target='_blank'>data</a> from the DGCA.</span>
                </p>
            </li>
            <li id='states-boundary-toggle'>
                <input type="checkbox" id="states-boundary"  onclick="toggleLayer(this.id)">
                State Boundaries
            </li>
        </ul>
        <h3>Airlinks Filters</h3>
        <div id='slider'></div>
        <div class='filter-info' id='airlinks-filter'></div>
        <div id='airlinks-city'>
            <p id='airlinks-city-text' style='color: #999'>All airports selected</p>
            <button id='airlinks-button' type="button" disabled='true' onclick='airlinksListUi()'>&gt;</button>
        </div>

        <div id='airlinks-list'></div>

        <h3>GDP Legend (INR Million per km<sup>2</sup>)</h3>
        <div class='my-legend'>
       <!--      <div class='legend-title'>Real GDP per km<sup>2</sup> (INR Million)</div> -->
            <div class='legend-scale'>
                <ul class='legend-labels' style='padding-left:0px;padding-top:0px;'>
                    <li><span style='background:#262626;'></span>&lt;100</li>
                    <li><span style='background:#ff9933;'></span>500</li>
                    <li><span style='background:#ff5050;'></span>1500</li>
                    <li><span style='background:#660033;'></span>&gt;1500</li>
                </ul>
            </div>
        </div>
    </div>


    <div id='allmaps'>
        <div id='map'></div>
        <div class = 'comparemaps' id='cmap1'></div>
        <div class = 'comparemaps' id='cmap2'></div>
    </div>
</div>

<script src="js/nouislider.min.js"></script>


<script>

// declaring variables

mapboxgl.accessToken = 'pk.eyJ1IjoiY2l0eS13YWxrYWJpbGl0eSIsImEiOiJjamFncnNkODUycHRnMzNuaW14eHE5d24yIn0.0ty0jyl5uuIF4fulta_vjg';

var states_tiles = 'wireman27.dzygdngz';
var states_layer = 'State_wi2';
var states_url = 'https://a.tiles.mapbox.com/v4/'+states_tiles+'/{z}/{x}/{y}.mvt?access_token='+mapboxgl.accessToken;
var gdp_tiles = 'wireman27.33q9yb3c';
var gdp_layer = 'gdpp_ws';
var url = 'https://a.tiles.mapbox.com/v4/'+gdp_tiles+'/{z}/{x}/{y}.mvt?access_token='+mapboxgl.accessToken;
var airlinks_tiles = 'wireman27.42n3ter9';
var airlinks_layer = 'air_links_t2';
var airlinks_url = 'https://a.tiles.mapbox.com/v4/'+airlinks_tiles+'/{z}/{x}/{y}.mvt?access_token='+mapboxgl.accessToken;
var currentZoom = 5;
var hoveredStateId =  null;
var bounds = [
    [50.22214724308444,7.167155470801902],
    [104.30007044563308,39.99115993534974]
];
var is_compare_states = false;
var selectedStates = [];
var bbox_correct = [-3,-3,3,3];
var compareAttributes = {
    "gsdp_mill":"Gross State Domestic Product (INR Million)",
    "gsdp_sqkm_mill": "GSDP (INR Million) Per Sq Km",
    "agri_ratio":"GSDP Attributable to Agriculture"
}
var table;
var statesMetadata; 
var statesMetadataUrl = 'https://raw.githubusercontent.com/wireman27/india_gdp_new/master/json/statesMetadata.json'
var links = document.getElementsByClassName("docs");
var slider = document.getElementById('slider');
var slideElement = document.getElementById('slider');
var airportMetadata;
var airportMetadataUrl = 'json/airportMetadata.json';
var selectedAirlinkCity = null;


// mapbox-gl-js functionality

var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/wireman27/cjjxpgblc4lco2spl206pi2d9',
    zoom: 4,
    center: [77.645, 21.69],
    pitch: 0,
    bearing: 0.6,
    minZoom: 3,
    hash: true,
    maxBounds: bounds
});

map.addControl(new MapboxGeocoder({
    accessToken: mapboxgl.accessToken,
    country: 'in'
}));

function addGdp(themap) {
    themap.addSource("gdp",{
        "type":"vector",
        "tiles": [url],
        "cluster":true
    });
}

function addStates(themap) {
    themap.addSource("states",{
        "type":"vector",
        "tiles": [states_url]
    });
}

function addAirlinks(themap) {
    themap.addSource("airlinks",{
        "type":"vector",
        "tiles": [airlinks_url]
    });
}


function addGdpLayer(themap) {
    themap.addLayer({
        "id": "gdp-data",
        "type": "fill-extrusion",
        "source": "gdp",
        "source-layer": gdp_layer,
        'paint': {
            'fill-extrusion-color': { 
                'property': 'gdpp_mill',
                'type': 'exponential',
                'stops': [ 
                [100,'#262626'],
                [500,'#ff9933'],
                [1500,'#ff5050'],
                [4000,'#660033']
                ]
            },
            'fill-extrusion-height': ["*",["get","gdpp_mill"], 10],
            'fill-extrusion-opacity': 0.6
        }
    });
}

function addStatesLayer(themap) {
    themap.addLayer({
        "id":"states",
        "type":"fill",
        "source": "states",
        "layout": {},
        "source-layer":states_layer,
        "paint": {
            "fill-color": ["case", ["boolean",["feature-state", "click"],false], "#ffffff","#e6e600"],
            "fill-opacity": ["case",
                ["any", ["boolean", ["feature-state", "hover"], false], ["boolean", ["feature-state", "click"], false] ],
                0.1,
                0
            ]
        }
    })
}

function addAirlinksLayer(themap) {
    themap.addLayer({
        "id":"airlinks",
        "type":"line",
        "source": "airlinks",
        "layout": {
            "visibility":'none',
            "line-cap":"round"
        },
        "source-layer":airlinks_layer,
        "paint": {
            "line-color": "orange",
            "line-width":["/",["get","twc"], 10000],
            "line-opacity": 1
        }
    })
}

function addStatesBoundary(themap) {
    themap.addLayer({
        "id":"states-boundary",
        "type":"line",
        "source": "states",
        "layout": {},
        "source-layer":states_layer,
        "paint": {
            "line-width": 0.3,
            "line-color": "#e6e6e6",
            "line-opacity": 0.6
        }
    })
}

function addDataLayer() {
    addGdpLayer(map);
    addStatesLayer(map);
    addAirlinksLayer(map);
    addStatesBoundary(map);
}

//making the map pretty

map.on('style.load', function () {
    addGdp(map);
    addStates(map);
    addAirlinks(map);
    document.getElementById('gdp-data').checked = true;
    document.getElementById('states-boundary').checked = true;
    addDataLayer();
    slider.setAttribute('disabled', true);
    slider.noUiSlider.on('update', function() {
        if (selectedAirlinkCity ==  null) {
            map.setFilter('airlinks',
            ["all",
                [">=","twc",parseInt(slider.noUiSlider.get()[0])],
                ["<=","twc",parseInt(slider.noUiSlider.get()[1])]
            ])
        } else {
            map.setFilter('airlinks',
            ["all",
                [">=","twc",parseInt(slider.noUiSlider.get()[0])],
                ["<=","twc",parseInt(slider.noUiSlider.get()[1])],
                ["any",
                    ["==","air1",selectedAirlinkCity],
                    ["==","air2",selectedAirlinkCity]
                ]
            ])
        };
        if(!slider.attributes['disabled']) {   
            populateAirlinksFilter();         
        }
    });
});


// compare tool functionality

function round(value, decimals) {
  return Number(Math.round(value+'e'+decimals)+'e-'+decimals);
}

const numberWithCommas = (x) => {
  return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")
};

function stringGenerator(attribute, value) {
    if (attribute == "gsdp_mill") {
        return(numberWithCommas(value));       
    }
    if (attribute == "agri_ratio") {
        return(round(value * 100,2).toString() + "%");
    }
    if (attribute == "gsdp_sqkm_mill") {
        return((round(value,2)).toString());
    } else {
        return(value);
    }
}

function backToHome() {
	backToHomeUI();
	for (var feat = 0;feat < selectedStates.length;feat++) {
		map.setFeatureState({source: 'states', sourceLayer: states_layer, id: selectedStates[feat].id},{click: false})
	}
	selectedStates = [];
	is_compare_states = false;

}

function compareTool() {

    is_compare_states = true;

    if(!statesMetadata) {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
       // Typical action to be performed when the document is ready:
                statesMetadata = JSON.parse(xhttp.responseText)
            }
        };
        xhttp.open("GET",statesMetadataUrl,true);
        xhttp.send();
    }

    compareToolUI();
}

function createBounds(turf_bounds) {
    var sum = turf_bounds.map(function (num, idx) {
        return num + bbox_correct[idx];
    })
    return(sum);
}

function goBackFromCompare() {

    compareTool();

    cmap1.remove();
    cmap2.remove();

    goBackFromCompareUI();
}

function compareStates() {

    if(selectedStates.length < 2) {
        alert("Please select more states!");
        return;
    }

    state1 = selectedStates[0]; state2 = selectedStates[1];
    center1 = turf.center(state1.geometry).geometry.coordinates; center2 = turf.center(state2.geometry).geometry.coordinates;
    bounds1 = createBounds(turf.bbox(state1)); bounds2 = createBounds(turf.bbox(state2));

    compareStatesUI();

    var cmap1 = new mapboxgl.Map({
        container: 'cmap1',
        style: 'mapbox://styles/wireman27/cjjxpgblc4lco2spl206pi2d9',
        zoom: 5,
        center: center1,
        minZoom: 5,
        maxBounds: bounds1
    });

    cmap1.on('load', function() {
        addGdp(cmap1);
        addGdpLayer(cmap1);
        addStates(cmap1);
        addStatesBoundary(cmap1);


        var filter1 = ["==","state_id",state1.properties.St_Csus_Cd];

        cmap1.setFilter('states-boundary',["==","St_Csus_Cd",state1.properties.St_Csus_Cd])
        cmap1.setFilter('gdp-data',filter1);
        
    });

    var cmap2 = new mapboxgl.Map({
        container: 'cmap2',
        style: 'mapbox://styles/wireman27/cjjxpgblc4lco2spl206pi2d9',
        zoom: 5,
        center: center2,
        minZoom: 5,
        maxBounds: bounds2
    });

    cmap2.on('load', function() {
        addGdp(cmap2);
        addGdpLayer(cmap2);
        addStates(cmap2);
        addStatesBoundary(cmap2);

        var filter2 = ["==","state_id",state2.properties.St_Csus_Cd];

        cmap2.setFilter('states-boundary',["==","St_Csus_Cd",state2.properties.St_Csus_Cd])
        cmap2.setFilter('gdp-data',filter2);
    });

    createComparisonTable();
}

function createComparisonTable() {

    table = document.createElement('table');
    table.setAttribute('id','compareTable');

    for (var att in compareAttributes) {
        var row = document.createElement('tr');

        var td1 = document.createElement('td'); var td2 = document.createElement('td'); var td3 = document.createElement('td'); 
        td1.setAttribute('class','td1');td2.setAttribute('class','td2');td3.setAttribute('class','td3');

        td1.innerText = stringGenerator(att,statesMetadata[selectedStates[0].id][att]);
        td2.innerText = compareAttributes[att];
        td3.innerText = stringGenerator(att,statesMetadata[selectedStates[1].id][att]);

        row.appendChild(td1); row.appendChild(td2); row.appendChild(td3);

        table.appendChild(row);
    }

    document.getElementById('container').appendChild(table);

    document.getElementsByClassName("mapboxgl-ctrl-attrib")[1].style.display = 'none';
    document.getElementsByClassName("mapboxgl-ctrl-logo")[1].style.display = 'none';
    document.getElementsByClassName("mapboxgl-ctrl-attrib")[2].style.display = 'none';
    document.getElementsByClassName("mapboxgl-ctrl-logo")[2].style.display = 'none';
}


// controls functionality

noUiSlider.create(slider, {
    start: [50000, 161402],
    connect: true,
    range: {
        'min': 0,
        '30%':20000,
        '50%':50000,
        '80%':80000,
        'max': 161402
    }
});


function toggleLayer(layerName) {
    if(map.getLayoutProperty(layerName, 'visibility') == 'none') {
        if(layerName == 'airlinks') {
            slider.removeAttribute('disabled')
            document.getElementById('airlinks-button').removeAttribute('disabled');
            populateAirlinksFilter();
            document.getElementById('airlinks-city-text').style.color = 'orange';
            if(!airportMetadata) {
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        airportMetadata = JSON.parse(xhttp.responseText)
                        genAirports();
                    }
                };
                xhttp.open("GET",airportMetadataUrl,true);
                xhttp.send();
            };
        }
        map.setLayoutProperty(layerName,'visibility','visible')
    } else {
        if(layerName == 'airlinks') {
            slider.setAttribute('disabled', true);
            document.getElementById('airlinks-filter').innerText = '';
            document.getElementById('airlinks-city-text').style.color = '#999';
            document.getElementById('airlinks-button').setAttribute('disabled','true');
            document.getElementById('airlinks-list').style.display = '';
        }
        map.setLayoutProperty(layerName,'visibility','none')
    }
}

function toggleControls() {
    if (document.getElementById('controls').style.display=='none') {
        document.getElementById('controls').style.display = 'block';
    } else {
        document.getElementById('controls').style.display = 'none';
    }
}

function populateAirlinksFilter() {
    document.getElementById('airlinks-filter').innerText= 
        'Between '+Math.round(slider.noUiSlider.get()[0])+
        ' & '+Math.round(slider.noUiSlider.get()[1])+
        ' passengers per week'
}

function genAirports() {
    for(var i in airportMetadata) {
        var p = document.createElement('p');
        p.innerHTML = i;
        p.setAttribute('onclick','popAirlinksListCity(this.innerHTML)');
        document.getElementById("airlinks-list").appendChild(p);
    };
}

function popAirlinksListCity(city) {
    document.getElementById("airlinks-city-text").innerText = city + ' selected';
    selectedAirlinkCity = airportMetadata[city]['iata_apt'];
    map.setFilter('airlinks',
        ["all",
            [">=","twc",parseInt(slider.noUiSlider.get()[0])],
            ["<=","twc",parseInt(slider.noUiSlider.get()[1])],
            ["any",
                ["==","air1",airportMetadata[city]['iata_apt']],
                ["==","air2",airportMetadata[city]['iata_apt']]
            ]
        ])
    document.getElementById("airlinks-list").style.display = "";
}

// events functionality


slideElement.onmouseover = function(){
    if(slider.attributes['disabled']){
        document.getElementById('airlinks-filter').innerText = 'Please enable the Airlinks filter';
    }
};

slideElement.onmouseleave = function(){
    if(slider.attributes['disabled']) {
        document.getElementById('airlinks-filter').innerText = '';
    }
};


map.on('click','states',function(e) {
    if (hoveredStateId && !is_compare_states) {
        var bbox = turf.bbox(e.features[0]);
        map.fitBounds(bbox);
    }
    if (is_compare_states && e.features.length > 0) {
        var clickStat = map.getFeatureState({source: 'states', sourceLayer: states_layer, id: e.features[0].id}).click
        if (clickStat != true) {
            if (selectedStates.length < 2) {
                map.setFeatureState({source: 'states', sourceLayer: states_layer, id: e.features[0].id},{click: true});
                selectedStates.push(e.features[0]);
            } 
        } else {
            map.setFeatureState({source: 'states', sourceLayer: states_layer, id: e.features[0].id},{click: false});
            selectedStates.pop(e.features[0]);
        }
    };
})

map.on("mousemove", "states", function(e) {
    if(map.getZoom() > 7) {
        map.setFeatureState({source: 'states', sourceLayer: states_layer, id: hoveredStateId}, { hover: false});
    } else {
    if (e.features.length > 0) {
        if (hoveredStateId) {
            map.setFeatureState({source: 'states', sourceLayer: states_layer, id: hoveredStateId}, { hover: false});
        }
        hoveredStateId = e.features[0].id;
        map.setFeatureState({source: 'states', sourceLayer: states_layer, id: hoveredStateId}, { hover: true});
    }        
    }
});

map.on("mouseleave", "states", function() {   
    if(map.getZoom() > 7) {
        map.setFeatureState({source: 'states', sourceLayer: states_layer, id: hoveredStateId}, { hover: false});
    }
    if (hoveredStateId) {
        map.setFeatureState({source: 'states', sourceLayer: states_layer, id: hoveredStateId}, { hover: false});
    }
    hoveredStateId =  null;
});


// map.addControl(new mapboxgl.FullscreenControl());




// map.on('zoomend', function(){
//     var zoomEnd = map.getZoom();
//     if(currentZoom < 9.5 && zoomEnd > 9.5) { 
//         //document.getElementById('loader').style.display = 'block';
//         map.setStyle('mapbox://styles/mapbox/satellite-v9?optimize=true')
//         currentZoom = zoomEnd;
//     }
//     if(currentZoom > 9.5 && zoomEnd < 9.5) { 
//         map.setStyle('mapbox://styles/mapbox/dark-v9?optimize=true')
//         currentZoom = zoomEnd;
//     }
// });

</script>

</body>
</html>